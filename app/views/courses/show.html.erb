<h2><%= @title %></h2>
<%
students = Student.find_by_teacher(current_user.id).to_a
students_in_course = @course.students.to_a
students |= students_in_course

# make a hash which maps school_id to arrays of student objects.
school_to_students = {}
School.all.each do |school|
  students_at_school = students.select { |student| student.school_id == school.id }
  school_to_students[school.id] = students_at_school.map { |student| student.attributes.to_h }
end
students_in_course = students_in_course.map { |student| student.id }
%>
<script>
  school_to_students = JSON.parse('<%== school_to_students.to_json %>')
  students_in_course = JSON.parse('<%== students_in_course.to_json %>')
</script>
<%= render '/shared/error_messages', object: @course %>
<%= form_for @course, remote: true do |course_f| %>
<div class="all-block">
  <%= course_f.label :name %>
  <%= course_f.text_field :name %>
  <%= course_f.label :start_date %>
  <%= course_f.date_field :start_date, value: Date.today %>
  <%= course_f.label :end_date %>
  <%= course_f.date_field :end_date %>
  <%= course_f.label :notes %>
  <%= course_f.text_area :notes %>
  <%= course_f.label :school %>
  <%= course_f.collection_select :school_id, School.all, :id, :name, { prompt: true }, { onchange: "show_students()" } %>
</div>
<div id="student_list_container" class="hidden">
  <ul id="student_list" class="student_list"></ul>
  <div id="add_student">
    <input type="text" id="new_student_first" placeholder="First name"/>
    <input type="text" id="new_student_last" placeholder="Last name"/>
    <button onclick="add_student(event)">Add Student</button>
  </div>
</div>
  <br>
  <%= course_f.submit %>
<% end %>
<script>
function add_student(e) {
  e.preventDefault()
  clear_error()
  let first_name = $("#new_student_first").val()
  let last_name = $("#new_student_last").val()
  let school_id = $("#course_school_id").val()
  if (!first_name || !last_name)
    return false
  $.ajax("/students/search",
    { method: "POST", dataType: "json", data: { first_name: first_name, last_name: last_name, school_id: school_id } })
    .done(function(id) {
      if (id > 0)
        student_found(id, first_name, last_name)
      else
        student_not_found()
    })
    .fail(function(result) {
      student_not_found()
    })
}
function clear_error() {
  $("#error_wrapper").html('')
}
function set_error(message) {
  $("#error_wrapper").html(`<ul><li>${message}</li></ul>`)
}
function show_students() {
  school_id = $("#course_school_id").val()
  if (!school_id) return
  student_list = $("#student_list")
  student_list.empty()
  school_to_students[school_id].forEach(student => student_list.append(student_checkbox(student.id, student.first_name, student.last_name)))
  $("#student_list_container").show()
}
function student_checkbox(id, first_name, last_name) {
  checked = students_in_course.includes(id) ? "checked" : ""
  return `<li><input type="checkbox" value="${id}" name="course[student_ids][]" id="course_student_ids_${id}" ${checked}><label for="course_student_ids_${id}">${first_name} ${last_name}</label></li>`
}
function student_found(id, first_name, last_name) {
  school_id = $("#course_school_id").val()
  if (students_in_course.includes(id) || school_to_students[school_id].map(student => student.id).includes(id)) {
    set_error("Student is already in the list")
    return false
  }
  students_in_course.push(id)
  $("#student_list").append(student_checkbox(id, first_name, last_name))
  $("#new_student_first").val('')
  $("#new_student_last").val('')
}
function student_not_found() {
  if (confirm("No student by that name at that school.  Are you trying to add a new student?")) {
    let first_name = $("#new_student_first").val()
    let last_name = $("#new_student_last").val()
    let school_id = $("#course_school_id").val()
    $.ajax("/students",
      { method: "POST", dataType: "json", data: { student: { first_name: first_name, last_name: last_name, school_id: school_id }}})
      .done(function(id) {
        if (id > 0)
          student_found(id, first_name, last_name)
        else
          set_error("Unable to create student")
      })
      .fail(function(result) {
        set_error("Unable to create student")
      })
  }
}
$(function() {
  show_students();
})
</script>