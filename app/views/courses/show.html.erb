<h2><%= @title %></h2>
<%
@students = Student.find_by_teacher(current_user.id)
# make a hash of hashes.  top layer is keyed on school_id.  second layer is student.id => student.name
school_to_students = {}
School.all.each do |school|
  school_to_students[school.id] = Student.select(:id, :first_name, :last_name).where(school_id: school.id).reduce({}) { |ids, student| ids.update(student.id => student.name) }
end
# id needs to be a string to compare with school_to_students
students_in_course = @course.students.map { |student| student.id.to_s }
%>
<script>
  school_to_students = '<%== school_to_students.to_json %>'
  school_to_students = JSON.parse(school_to_students)
  students_in_course = '<%== students_in_course.to_json %>'
  students_in_course = JSON.parse(students_in_course)
</script>
<%= render '/shared/error_messages', object: @course %>
<%= form_for @course, remote: true do |course_f| %>
<div class="all-block">
  <%= course_f.label :name %>
  <%= course_f.text_field :name %>
  <%= course_f.label :start_date %>
  <%= course_f.date_field :start_date, value: Date.today %>
  <%= course_f.label :end_date %>
  <%= course_f.date_field :end_date %>
  <%= course_f.label :notes %>
  <%= course_f.text_area :notes %>
  <%= course_f.label :school %>
  <%= course_f.collection_select :school_id, School.all, :id, :name, { prompt: true }, { onchange: "show_schools()" } %>
</div>
  <ul id="student_list"></ul>
  <br>
  <%= course_f.submit %>
<% end %>
<script>
function show_schools() {
  school_id = $("#course_school_id").val()
  if (!school_id) return
  student_list = $("#student_list")
  student_list.empty()
  Object.keys(school_to_students[school_id]).forEach(student_id => student_list.append(student_checkbox(student_id, school_to_students[school_id][student_id])))
  $("#student_list").show()
}
function student_checkbox(id, name) {
  checked = students_in_course.includes(id) ? "checked" : ""
  return `<li><input type="checkbox" value="${id}" name="course[student_ids][]" id="course_student_ids_${id}" ${checked}><label for="course_student_ids_${id}">${name}</label></li>`
}
$(function() {
  show_schools();
})
</script>